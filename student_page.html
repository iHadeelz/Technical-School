<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù„ÙˆØ­Ø© Ø§Ù„Ø·Ø§Ù„Ø¨ | TechFlow Academy</title>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root {
            --primary-dark: #0f172a; --trust-blue: #1e293b; --accent-gold: #fbbf24;
            --white: #ffffff; --header-height: 80px; --sidebar-width: 280px;
        }

        body {
            font-family: 'Tajawal', sans-serif;
            background: radial-gradient(circle at center, #1e293b 0%, #0f172a 100%);
            margin: 0; display: flex; color: var(--white); height: 100vh; overflow: hidden;
        }

        /* --- Ø§Ù„Ù‡ÙŠØ¯Ø± --- */
        header {
            position: fixed; top: 0; right: 0; left: 0; height: var(--header-height);
            background: rgba(15, 23, 42, 0.9); backdrop-filter: blur(10px);
            display: flex; justify-content: space-between; align-items: center;
            padding: 0 40px; z-index: 1001; border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        .header-controls { display: flex; align-items: center; gap: 20px; }

        /* Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª */
        .notif-wrapper { position: relative; cursor: pointer; }
        .bell-icon { font-size: 1.4rem; color: #94a3b8; transition: 0.3s; position: relative; }
        .notif-badge { 
            position: absolute; top: -2px; right: -2px; background: #ef4444; 
            width: 10px; height: 10px; border-radius: 50%; border: 2px solid var(--primary-dark); display: none;
        }

        .notif-dropdown {
            position: absolute; top: 50px; left: 0; width: 300px;
            background: var(--trust-blue); border: 1px solid rgba(255,255,255,0.1);
            border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            display: none; flex-direction: column; overflow: hidden; z-index: 2000;
        }
        .notif-dropdown.show { display: flex; animation: slideDown 0.3s ease; }
        .notif-header { padding: 12px; background: rgba(255,255,255,0.05); font-weight: bold; border-bottom: 1px solid rgba(255,255,255,0.1); }
        .notif-item { padding: 12px; border-bottom: 1px solid rgba(255,255,255,0.05); font-size: 0.85rem; }

        /* Ø§Ù„Ø¨Ø±ÙˆÙØ§ÙŠÙ„ */
        .user-profile-btn { display: flex; align-items: center; gap: 12px; cursor: pointer; }
        .avatar { width: 38px; height: 38px; background: var(--accent-gold); color: var(--primary-dark); border-radius: 10px; display: flex; align-items: center; justify-content: center; font-weight: bold; }

        /* Ø§Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠ */
        .main-sidebar {
            width: var(--sidebar-width); background: rgba(15, 23, 42, 0.5);
            height: 100vh; position: fixed; right: 0; top: 0;
            padding-top: calc(var(--header-height) + 10px);
            border-left: 1px solid rgba(255,255,255,0.05); display: flex; flex-direction: column;
        }
        .nav-link { padding: 12px 25px; margin: 2px 15px; color: #94a3b8; border-radius: 10px; cursor: pointer; transition: 0.3s; }
        .nav-link.active { background: rgba(251, 191, 36, 0.1); color: var(--accent-gold); }

        /* Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ */
        .main-content {
            margin-right: var(--sidebar-width); margin-top: var(--header-height);
            width: calc(100% - var(--sidebar-width)); padding: 30px;
            display: grid; grid-template-columns: 1.8fr 1.2fr; gap: 25px;
            height: calc(100vh - var(--header-height)); box-sizing: border-box; overflow-y: auto;
        }

        .video-container { width: 100%; aspect-ratio: 16/9; background: #000; border-radius: 16px; overflow: hidden; box-shadow: 0 20px 40px rgba(0,0,0,0.4); }
        .video-container iframe { width: 100%; height: 100%; border: none; }

        .category-card { background: rgba(255, 255, 255, 0.03); padding: 15px; border-radius: 20px; margin-bottom: 20px; border: 1px solid rgba(255,255,255,0.1); }
        .lesson-box { padding: 12px; margin-top: 8px; border-radius: 10px; background: rgba(255,255,255,0.03); cursor: pointer; transition: 0.2s; }
        .lesson-box:hover { background: rgba(251, 191, 36, 0.1); }

        /* Ø§Ù„Ù…ÙˆØ¯Ø§Ù„Ø§Øª */
        .modal-overlay, .quiz-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.85); backdrop-filter: blur(10px); display: none; align-items: center; justify-content: center; z-index: 2000; }
        .quiz-window { background: var(--trust-blue); width: 400px; padding: 30px; border-radius: 24px; border: 1px solid var(--accent-gold); }
        
       @keyframes slideInLeft {
    from { opacity: 0; transform: translateX(-100px); }
    to { opacity: 1; transform: translateX(0); }
}
    </style>
</head>
<body>
<div id="globalAnnouncement" style="display: none; position: fixed; top: 20px; left: 20px; width: 300px; background: #1e293b; color: white; border-right: 5px solid var(--accent-gold); padding: 15px; border-radius: 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); z-index: 9999; animation: slideInLeft 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55);">
    <div style="display: flex; align-items: flex-start; gap: 12px;">
        <div style="background: var(--accent-gold); color: var(--primary-dark); width: 35px; height: 35px; border-radius: 50%; display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
            <i class="fas fa-bullhorn"></i>
        </div>
        <div style="flex-grow: 1;">
            <div style="font-weight: bold; font-size: 0.85rem; color: var(--accent-gold); margin-bottom: 4px;">Ø¥Ø¹Ù„Ø§Ù† : </div>
            <div id="announcementMsg" style="font-size: 0.8rem; line-height: 1.4;">...</div>
        </div>
        <button onclick="this.parentElement.parentElement.style.display='none'" style="background: none; border: none; color: #64748b; cursor: pointer; font-size: 1rem;">Ã—</button>
    </div>
</div>
    <div class="modal-overlay" id="profileModal">
       <div class="profile-modal" style="background: #161e2e; width: 350px; border-radius: 30px; border: 1px solid var(--accent-gold); overflow: hidden;">
    <div style="height: 80px; background: linear-gradient(45deg, #1e293b, #0f172a); position: relative;">
        <div id="modalAvatar" style="width: 70px; height: 70px; background: var(--accent-gold); color: #000; border-radius: 20px; font-size: 2rem; font-weight: 800; display: flex; align-items: center; justify-content: center; position: absolute; bottom: -35px; right: 20px; border: 4px solid #161e2e;">H</div>
    </div>
    <div style="padding: 50px 25px 25px; text-align: right;">
        <h3 id="modalFullName" style="margin: 0;">ØªØ­Ù…ÙŠÙ„...</h3>
        <p style="color: var(--accent-gold); font-size: 0.8rem; margin-bottom: 15px;">Ø·Ø§Ù„Ø¨Ø© Ø£ÙƒØ§Ø¯ÙŠÙ…ÙŠØ© ØªÙŠÙƒ ÙÙ„Ùˆ âœ¨</p>
        
        <div style="background: rgba(255,255,255,0.03); padding: 10px; border-radius: 10px; margin-bottom: 10px; font-size: 0.8rem; border-right: 3px solid var(--accent-gold);">
            <small style="color: #64748b;">Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ:</small><br>
            <span id="userEmail">...</span>
        </div>

        <a href="https://wa.me/966545603319" target="_blank" style="display: flex; align-items: center; justify-content: center; gap: 8px; background: #25d366; color: white; padding: 12px; border-radius: 12px; text-decoration: none; font-weight: bold; margin: 15px 0; font-size: 0.9rem;">
            <i class="fab fa-whatsapp"></i> ØªÙˆØ§ØµÙ„Ù Ù…Ø¹ Ù….Ù‡Ø¯ÙŠÙ„
        </a>

        <button id="logoutBtnModal" style="width:100%; background: #ef4444; color:white; border:none; padding:10px; border-radius:10px; font-weight:bold; cursor:pointer;">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</button>
        <button onclick="toggleModal()" style="width:100%; background:none; color:#64748b; border:none; margin-top:10px; cursor:pointer;">Ø¥ØºÙ„Ø§Ù‚</button>
    </div>
</div>
        </div>
    </div>

    <div class="quiz-overlay" id="quizOverlay">
        <div class="quiz-window">
            <div id="quizStage1">
                <h3 style="text-align: center;">ğŸ¯ Ø§Ø®ØªØ± Ù…Ø³Ø§Ø± Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±</h3>
                <div class="nav-link" style="border:1px solid rgba(255,255,255,0.1); margin:10px 0;" onclick="startChapterQuiz('cyber')">ğŸ›¡ï¸ Ø§Ù„Ø£Ù…Ù† Ø§Ù„Ø³ÙŠØ¨Ø±Ø§Ù†ÙŠ</div>
                <div class="nav-link" style="border:1px solid rgba(255,255,255,0.1); margin:10px 0;" onclick="startChapterQuiz('cloud')">â˜ï¸ Ø§Ù„Ø­ÙˆØ³Ø¨Ø© Ø§Ù„Ø³Ø­Ø§Ø¨ÙŠØ©</div>
                <div class="nav-link" style="border:1px solid rgba(255,255,255,0.1); margin:10px 0;" onclick="startChapterQuiz('programming')">ğŸ’» Ù„ØºØ§Øª Ø§Ù„Ø¨Ø±Ù…Ø¬Ø©</div>
            </div>
            <div id="quizStage2" style="display: none;">
                <h4 id="quizQuestion">...</h4>
                <div id="quizOptions"></div>
            </div>
            <button onclick="closeQuiz()" style="width:100%; background:none; border:none; color:#94a3b8; margin-top:15px; cursor:pointer;">Ø¥Ù„ØºØ§Ø¡</button>
        </div>
    </div>

    <header>
        <div class="header-logo" style="font-weight: 800; font-size: 1.2rem;">TechFlow <span style="color: var(--accent-gold);">Academy</span></div>
        <div class="header-controls">
            <div class="notif-wrapper" onclick="toggleNotifs()">
    <div class="bell-icon"><i class="fas fa-bell"></i><div class="notif-badge" id="notifBadge"></div></div>
    <div class="notif-dropdown" id="notifDropdown">
        <div class="notif-header">ğŸ”” Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡Ø§Øª</div>
        <div id="notificationList"><div style="padding:15px; text-align:center; font-size:0.8rem;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¥Ø´Ø¹Ø§Ø±Ø§Øª</div></div>
    </div>
</div> 

            <div class="user-profile-btn" onclick="toggleModal()">
    <div style="text-align: right; line-height: 1.2;">
        <div id="headerUserName" style="font-weight: bold; font-size: 0.9rem;">Ø¬Ø§Ø±Ù Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>
        <div style="font-size: 0.7rem; color: var(--accent-gold);">Ø·Ø§Ù„Ø¨Ø© Ø°Ù‡Ø¨ÙŠØ© âœ¨</div>
    </div>
    <div class="avatar" id="headerAvatar">H</div>
</div>
    </header>

    <div class="main-sidebar">
        <div class="nav-link active"><i class="fas fa-play-circle"></i> Ø¯ÙˆØ±Ø§ØªÙŠ Ø§Ù„ØªØ¹Ù„ÙŠÙ…ÙŠØ©</div>
        <div class="nav-link" onclick="openQuizPanel()"><i class="fas fa-question-circle"></i> Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª</div>
        <div style="margin-top: auto; padding: 20px;">
            <button class="nav-link" style="width: 100%; border: none; background: rgba(239, 68, 68, 0.1); color: #ef4444;" onclick="logoutAction()">
                <i class="fas fa-sign-out-alt"></i> Ø®Ø±ÙˆØ¬
            </button>
        </div>
    </div>

    <main class="main-content">
        <div class="video-section">
            <div class="video-container">
               <div class="video-container">
    <iframe 
        id="mainPlayer" 
        src="" 
        allow="autoplay; fullscreen; SharableContent" 
        allowfullscreen 
        referrerpolicy="no-referrer-when-downgrade">
    </iframe>
</div>
            </div>
            <h2 id="currentTitle" style="margin-top: 20px;">Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨ÙƒÙØŒ Ø§Ø¨Ø¯Ø¦ÙŠ Ø§Ù„ØªØ¹Ù„Ù… Ø§Ù„Ø¢Ù† ğŸš€</h2>

            <div class="comments-section" style="background: rgba(255,255,255,0.03); margin-top: 25px; padding: 20px; border-radius: 20px; border: 1px solid rgba(255,255,255,0.1);">
                <h4 style="margin: 0 0 15px 0; color: var(--accent-gold);">ØªÙ‚ÙŠÙŠÙ…Ùƒ ÙˆØªØ¹Ù„ÙŠÙ‚Ùƒ Ù„Ù„Ø¯Ø±Ø³ âœ¨</h4>
                <div id="starRating" style="font-size: 1.4rem; margin-bottom: 15px; cursor: pointer;">
                    <span onclick="setRating(1)">â­</span><span onclick="setRating(2)">â­</span><span onclick="setRating(3)">â­</span><span onclick="setRating(4)">â­</span><span onclick="setRating(5)">â­</span>
                </div>
                <textarea id="commentInput" placeholder="Ø§ÙƒØªØ¨ÙŠ Ø±Ø£ÙŠÙƒ Ù‡Ù†Ø§..." style="width: 100%; background: rgba(0,0,0,0.2); border: 1px solid rgba(255,255,255,0.1); border-radius: 12px; padding: 12px; color: white; font-family: 'Tajawal'; resize: none; height: 70px; box-sizing: border-box;"></textarea>
                <button onclick="submitComment()" style="background: var(--accent-gold); color: var(--primary-dark); border: none; padding: 10px 20px; border-radius: 10px; margin-top: 10px; font-weight: bold; cursor: pointer;">Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØªØ¹Ù„ÙŠÙ‚</button>
                <div id="publicComments" style="margin-top: 20px; font-size: 0.8rem; color: #64748b;">Ø§Ù„ØªØ¹Ù„ÙŠÙ‚Ø§Øª Ø§Ù„Ù…Ø¹ØªÙ…Ø¯Ø© ØªØ¸Ù‡Ø± Ù‡Ù†Ø§..</div>
            </div>
        </div>

        <div class="lessons-list">
            <div class="category-card"><h3>ğŸ›¡ï¸ Ø§Ù„Ø£Ù…Ù† Ø§Ù„Ø³ÙŠØ¨Ø±Ø§Ù†ÙŠ</h3><div id="cyberLessons"></div></div>
            <div class="category-card"><h3>â˜ï¸ Ø§Ù„Ø­ÙˆØ³Ø¨Ø© Ø§Ù„Ø³Ø­Ø§Ø¨ÙŠØ©</h3><div id="cloudLessons"></div></div>
            <div class="category-card"><h3>ğŸ’» Ù„ØºØ§Øª Ø§Ù„Ø¨Ø±Ù…Ø¬Ø©</h3><div id="programmingLessons"></div></div>
        </div>
    </main>

<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
<script>
    const firebaseConfig = {
        apiKey: "AIzaSyCB76yITZG4XNa6AXNPkIR8PxLZuMv1j3Y",
        authDomain: "techflowacademy-3e89c.firebaseapp.com",
        projectId: "techflowacademy-3e89c",
        appId: "1:373744584399:web:a57f9fb4f6129cd5e059ba"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    let currentRating = 0;
    let currentLessonTitle = "";

    // --- ÙˆØ¸Ø§Ø¦Ù Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© ---
    function toggleNotifs() { document.getElementById('notifDropdown').classList.toggle('show'); document.getElementById('notifBadge').style.display = 'none'; }
    function toggleModal() { const m = document.getElementById('profileModal'); m.style.display = (m.style.display === 'flex') ? 'none' : 'flex'; }
    // --- ØªØ­Ø¯ÙŠØ« ÙˆØ¸ÙŠÙØ© Ø¹Ø±Ø¶ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª ÙÙŠ Ù„ÙˆØ­Ø© Ø§Ù„Ø·Ø§Ù„Ø¨ ---

async function openQuizPanel() {
    document.getElementById('quizOverlay').style.display = 'flex';
    const stage1 = document.getElementById('quizStage1');
    stage1.innerHTML = `<h3 style="text-align: center;">ğŸ¯ Ø¬Ø§Ø±ÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ù…Ø³Ø§Ø±Ø§Øª...</h3>`;

    try {
        // Ø¬Ù„Ø¨ ÙƒÙ„ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø© Ù„ØªÙˆØ²ÙŠØ¹Ù‡Ø§
        const snap = await db.collection("quizzes").get();
        
        if (snap.empty) {
            stage1.innerHTML = `
                <div style="text-align:center; padding:20px;">
                    <p>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª Ù…Ø¶Ø§ÙØ© Ø­Ø§Ù„ÙŠØ§Ù‹ ğŸŒ¸</p>
                    <small>  Ø³ÙŠØªÙ… Ø£Ø¶Ø§ÙØªÙ‡Ø§ Ù‚Ø±ÙŠØ¨Ø§.  </small>
                </div>`;
            return;
        }

        stage1.innerHTML = `<h3 style="text-align: center;">ğŸ¯ Ø§Ø®ØªØ§Ø±ÙŠ Ø§Ù„Ù…Ø³Ø§Ø±</h3>`;
        
        // Ù…ØµÙÙˆÙØ© Ø§Ù„Ù…Ø³Ø§Ø±Ø§Øª Ø§Ù„Ù…ØªØ§Ø­Ø©
        const cats = [
            { id: 'cyber', name: 'ğŸ›¡ï¸ Ø§Ù„Ø£Ù…Ù† Ø§Ù„Ø³ÙŠØ¨Ø±Ø§Ù†ÙŠ' },
            { id: 'cloud', name: 'â˜ï¸ Ø§Ù„Ø­ÙˆØ³Ø¨Ø© Ø§Ù„Ø³Ø­Ø§Ø¨ÙŠØ©' },
            { id: 'programming', name: 'ğŸ’» Ù„ØºØ§Øª Ø§Ù„Ø¨Ø±Ù…Ø¬Ø©' }
        ];

        cats.forEach(cat => {
            const div = document.createElement('div');
            div.className = "nav-link";
            div.style.border = "1px solid rgba(255,255,255,0.1)";
            div.style.margin = "10px 0";
            div.innerHTML = cat.name;
            div.onclick = () => loadChapters(cat.id); // Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ ÙˆØ¸ÙŠÙØ© ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙØµÙˆÙ„
            stage1.appendChild(div);
        });

    } catch (error) {
        console.error("Error:", error);
        stage1.innerHTML = "Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª";
    }
}

async function loadChapters(cat) {
    const quizStage1 = document.getElementById('quizStage1');
    quizStage1.innerHTML = `<h4 style="text-align:center;">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙØµÙˆÙ„...</h4>`;

    const snap = await db.collection("quizzes").where("category", "==", cat).get();
    
    if (snap.empty) {
        quizStage1.innerHTML = `
            <div style="text-align:center;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª Ù‡Ù†Ø§ Ø¨Ø¹Ø¯ ğŸŒ¸</div>
            <button onclick="openQuizPanel()" style="background:none; border:1px solid; color:white; padding:5px; margin-top:10px; cursor:pointer;">Ø¹ÙˆØ¯Ø©</button>
        `;
        return;
    }

    // Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„ÙØµÙˆÙ„ Ø§Ù„ÙØ±ÙŠØ¯Ø©
    const chapters = [...new Set(snap.docs.map(doc => doc.data().chapter))];

    quizStage1.innerHTML = `<h3 style="text-align: center;">ğŸ“– Ø§Ø®ØªØ§Ø±ÙŠ Ø§Ù„ÙØµÙ„</h3>`;
    chapters.forEach(chapName => {
        const div = document.createElement('div');
        div.className = "nav-link";
        div.style.border = "1px solid rgba(255,255,255,0.1)";
        div.style.margin = "10px 0";
        div.innerHTML = `<i class="fas fa-book"></i> ${chapName}`;
        div.onclick = () => startChapterQuiz(cat, chapName);
        quizStage1.appendChild(div);
    });
}

async function startChapterQuiz(cat, chapter) {
    const snap = await db.collection("quizzes")
        .where("category", "==", cat)
        .where("chapter", "==", chapter)
        .get();

    if (snap.empty) return;

    document.getElementById('quizStage1').style.display = 'none';
    document.getElementById('quizStage2').style.display = 'block';
    
    // Ù„Ù†Ø£Ø®Ø° Ø§Ù„Ø³Ø¤Ø§Ù„ Ø§Ù„Ø£ÙˆÙ„ ÙƒÙ…Ø«Ø§Ù„ (ÙŠÙ…ÙƒÙ†Ùƒ ØªØ·ÙˆÙŠØ±Ù‡Ø§ Ù„ØªÙƒÙˆÙ† Ù…ØµÙÙˆÙØ© Ø£Ø³Ø¦Ù„Ø© Ù„Ø§Ø­Ù‚Ø§Ù‹)
    const q = snap.docs[0].data();
    document.getElementById('quizQuestion').innerText = `${chapter} : ${q.question}`;
    
    const optBox = document.getElementById('quizOptions');
    optBox.innerHTML = "";
    
    q.options.forEach((option, i) => {
        const btn = document.createElement('div');
        btn.className = "nav-link";
        btn.style.border = "1px solid rgba(255,255,255,0.1)";
        btn.innerText = option;
        btn.onclick = () => {
            if(i == q.correct) {
                alert(`Ø¥Ø¬Ø§Ø¨Ø© ØµØ­ÙŠØ­Ø© ÙÙŠ ${chapter}! Ø£Ù†ØªÙ Ù…Ø°Ù‡Ù„Ø© ğŸŒŸ`);
            } else {
                alert("Ø­Ø§ÙˆÙ„ÙŠ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰ØŒ Ø§Ù„Ø¹Ù„Ù… ÙŠØ£ØªÙŠ Ø¨Ø§Ù„ØªÙƒØ±Ø§Ø± ğŸŒ¸");
            }
            closeQuiz();
        };
        optBox.appendChild(btn);
    });
}
    function closeQuiz() { document.getElementById('quizOverlay').style.display = 'none'; document.getElementById('quizStage1').style.display = 'block'; document.getElementById('quizStage2').style.display = 'none'; }
    
    function setRating(n) {
        currentRating = n;
        const stars = document.querySelectorAll('#starRating span');
        stars.forEach((s, i) => s.style.opacity = i < n ? "1" : "0.3");
    }
// --- Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø© ÙˆØ¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª + Ù…ÙŠØ²Ø© Ø§Ø´ØªÙ‚Ù†Ø§ Ù„ÙƒÙ ---
    auth.onAuthStateChanged(async (user) => {
        if (user) {
            document.getElementById('userEmail').innerText = user.email;
            
            const userRef = db.collection("students").doc(user.uid);
            const doc = await userRef.get();
            
            if (doc.exists) {
                const data = doc.data();
                const name = data.first_name || "Ø·Ø§Ù„Ø¨Ø© ØªÙŠÙƒ ÙÙ„Ùˆ";
                
                // --- Ù…ÙŠØ²Ø© "Ø§Ø´ØªÙ‚Ù†Ø§ Ù„ÙƒÙ" ---
                if (data.lastSeen) {
                    const lastSeenDate = data.lastSeen.toDate();
                    const now = new Date();
                    const diffTime = Math.abs(now - lastSeenDate);
                    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

                    // Ø¥Ø°Ø§ ØºØ§Ø¨Øª Ø£ÙƒØ«Ø± Ù…Ù† 3 Ø£ÙŠØ§Ù… (Ù…Ø«Ù„Ø§Ù‹ 3 Ø£ÙŠØ§Ù… ÙØ£ÙƒØ«Ø±)
                    if (diffDays >= 3) {
                        setTimeout(() => {
                            alert(`Ø£Ù‡Ù„Ø§Ù‹ Ø¨Ø¹ÙˆØ¯ØªÙƒÙ ÙŠØ§ ${name} ğŸŒ¸.. Ø§Ø´ØªÙ‚Ù†Ø§ Ù„ÙƒÙ ÙˆÙ„Ø­Ù…Ø§Ø³ÙƒÙ ÙÙŠ Ø§Ù„Ø£ÙƒØ§Ø¯ÙŠÙ…ÙŠØ©! Ø¯Ø¹ÙŠÙ†Ù†Ø§ Ù†ÙƒÙ…Ù„ Ø±Ø­Ù„Ø© Ø§Ù„Ø¥Ø¨Ø¯Ø§Ø¹ Ø§Ù„ÙŠÙˆÙ… âœ¨`);
                        }, 1500); // ÙŠØ¸Ù‡Ø± Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡ Ø¨Ø¹Ø¯ 1.5 Ø«Ø§Ù†ÙŠØ© Ù…Ù† Ø¯Ø®ÙˆÙ„Ù‡Ø§
                    }
                }

                // --- ØªØ­Ø¯ÙŠØ« Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© ---
                document.getElementById('headerUserName').innerText = name;
                document.getElementById('modalFullName').innerText = name;
                const char = name.charAt(0).toUpperCase();
                document.getElementById('headerAvatar').innerText = char;
                document.getElementById('modalAvatar').innerText = char;

                // --- ØªØ­Ø¯ÙŠØ« "Ø¢Ø®Ø± Ø¸Ù‡ÙˆØ±" Ùˆ "Ø­Ø§Ù„Ø© Ø§Ù„Ù†Ø´Ø§Ø·" ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ---
                await userRef.update({
                    lastSeen: firebase.firestore.FieldValue.serverTimestamp(),
                    isOnline: true
                });
            }
            
            loadLessons();
            listenNotifs();
        } else {
            window.location.href = "login.html";
        }
    });

    function loadLessons() {
        db.collection("lessons").orderBy("createdAt", "desc").onSnapshot(snap => {
            const sections = { cyber: 'cyberLessons', cloud: 'cloudLessons', programming: 'programmingLessons' };
            Object.values(sections).forEach(id => document.getElementById(id).innerHTML = "");
            snap.forEach(doc => {
                const lesson = doc.data();
                const div = document.createElement('div');
                div.className = "lesson-box";
                div.innerHTML = `<i class="fas fa-play-circle" style="color:var(--accent-gold); margin-left:10px;"></i> ${lesson.title}`;
                div.onclick = () => playVideo(lesson.url, lesson.title);
                document.getElementById(sections[lesson.category] || 'cyberLessons').appendChild(div);
            });
        });
    }

 function loadPublicComments(lessonTitle) {
        const commentsDiv = document.getElementById('publicComments');
        
        // Ø¬Ù„Ø¨ Ø§Ù„ØªØ¹Ù„ÙŠÙ‚Ø§Øª Ø§Ù„Ù…Ø¹ØªÙ…Ø¯Ø© Ù„Ù‡Ø°Ø§ Ø§Ù„Ø¯Ø±Ø³ ØªØ­Ø¯ÙŠØ¯Ø§Ù‹
        db.collection("comments")
            .where("lesson", "==", lessonTitle)
            .where("status", "==", "approved")
            .onSnapshot(snap => {
                if (snap.empty) {
                    commentsDiv.innerHTML = "<div style='text-align:center; padding:10px;'>Ù„Ø§ ØªÙˆØ¬Ø¯ ØªØ¹Ù„ÙŠÙ‚Ø§Øª Ù…Ø¹ØªÙ…Ø¯Ø© Ù„Ù‡Ø°Ø§ Ø§Ù„Ø¯Ø±Ø³ Ø¨Ø¹Ø¯.. ÙƒÙˆÙ†ÙŠ Ø§Ù„Ø£ÙˆÙ„Ù‰! âœ¨</div>";
                    return;
                }
                
                let commentsArray = [];
                snap.forEach(doc => commentsArray.push(doc.data()));

                // ØªØ±ØªÙŠØ¨ Ø§Ù„ØªØ¹Ù„ÙŠÙ‚Ø§Øª Ø¨Ø±Ù…Ø¬ÙŠØ§Ù‹ Ù„ØªØ¬Ù†Ø¨ Ù…Ø´Ø§ÙƒÙ„ Ø§Ù„Ù€ Index ÙÙŠ Firebase
                commentsArray.sort((a, b) => (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0));

                commentsDiv.innerHTML = "";
                commentsArray.forEach(data => {
                    const date = data.createdAt ? data.createdAt.toDate().toLocaleDateString('ar-SA') : "Ø§Ù„Ø¢Ù†";
                    const commentEl = document.createElement('div');
                    commentEl.style.cssText = "background: rgba(255,255,255,0.05); padding: 10px; border-radius: 10px; margin-bottom: 10px; border-right: 2px solid var(--accent-gold);";
                    commentEl.innerHTML = `
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <strong style="color: var(--accent-gold); font-size: 0.85rem;">${data.studentName}</strong>
                            <small style="color: #64748b; font-size: 0.7rem;">${date}</small>
                        </div>
                        <div style="color: #e2e8f0; font-size: 0.8rem; margin-top: 5px;">${data.comment}</div>
                        <div style="font-size: 0.7rem; margin-top: 5px;">${"â­".repeat(data.rating)}</div>`;
                    commentsDiv.appendChild(commentEl);
                });
            });
    }

  function playVideo(url, title) {
    let finalUrl = url;
    currentLessonTitle = title;

    if (url.includes("youtube.com") || url.includes("youtu.be")) {
        let id = url.includes("v=") ? url.split('v=')[1].split('&')[0] : url.split('/').pop();
        finalUrl = `https://www.youtube.com/embed/${id}?autoplay=1`;
    } 
    else if (url.includes("drive.google.com")) {
        // Ù‡Ø¯ÙˆÙ„ØªÙŠØŒ Ù‡Ù†Ø§ Ø§Ø³ØªØ®Ù„ØµÙ†Ø§ Ù…Ø¹Ø±Ù Ø§Ù„ÙÙŠØ¯ÙŠÙˆ (ID) Ù…Ù‡Ù…Ø§ ÙƒØ§Ù† Ø´ÙƒÙ„ Ø§Ù„Ø±Ø§Ø¨Ø·
        let fileId = "";
        try {
            if (url.includes("/file/d/")) {
                fileId = url.split('/file/d/')[1].split('/')[0].split('?')[0];
            } else if (url.includes("id=")) {
                fileId = url.split('id=')[1].split('&')[0];
            }
            // ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø±Ø§Ø¨Ø· Ù„ØµÙŠØºØ© Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„Ø±Ø³Ù…ÙŠØ© Ø§Ù„ØªÙŠ ØªÙ‚Ø¨Ù„ Ø§Ù„ØªØ¶Ù…ÙŠÙ†
            finalUrl = `https://drive.google.com/file/d/${fileId}/preview`;
        } catch (e) {
            console.error("Ø®Ø·Ø£ ÙÙŠ Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ù…Ø¹Ø±Ù Ù…Ù„Ù Ø¯Ø±Ø§ÙŠÙ:", e);
            finalUrl = url.replace('/view', '/preview'); // Ø­Ù„ Ø§Ø­ØªÙŠØ§Ø·ÙŠ
        }
    }

    const player = document.getElementById('mainPlayer');
    player.src = finalUrl;
    document.getElementById('currentTitle').innerText = title;
    
    // ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªØ¹Ù„ÙŠÙ‚Ø§Øª Ø§Ù„Ø®Ø§ØµØ© Ø¨Ø§Ù„Ø¯Ø±Ø³
    loadPublicComments(title); 
}

    // --- Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª ---
    function timeSince(timestamp) {
        if (!timestamp) return "Ø§Ù„Ø¢Ù†";
        const seconds = Math.floor((new Date() - timestamp.toDate()) / 1000);
        if (seconds < 60) return "Ø§Ù„Ø¢Ù†";
        const minutes = Math.floor(seconds / 60);
        if (minutes < 60) return `Ù…Ù†Ø° ${minutes} Ø¯`;
        const hours = Math.floor(minutes / 60);
        if (hours < 24) return `Ù…Ù†Ø° ${hours} Ø³Ø§Ø¹Ø©`;
        return timestamp.toDate().toLocaleDateString('ar-SA');
    }
function listenNotifs() {
    const list = document.getElementById('notificationList');
    const badge = document.getElementById('notifBadge');
    const sound = new Audio('https://assets.mixkit.co/active_storage/sfx/2358/2358-preview.mp3');
    
    // Ù…ØµÙÙˆÙØ© Ù„ØªØ®Ø²ÙŠÙ† ÙƒÙ„ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ù…Ù† Ø§Ù„Ù…ØµØ§Ø¯Ø± Ø§Ù„Ù…Ø®ØªÙ„ÙØ© Ù„ØªØ±ØªÙŠØ¨Ù‡Ø§ Ø²Ù…Ù†ÙŠØ§Ù‹
    let allNotifications = [];

    const updateUI = () => {
        if (allNotifications.length === 0) {
            list.innerHTML = '<div style="padding:15px; text-align:center; font-size:0.8rem;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø­Ø§Ù„ÙŠØ§Ù‹ ğŸŒ¸</div>';
            return;
        }
        
        // ØªØ±ØªÙŠØ¨ Ø§Ù„ÙƒÙ„ Ù…Ù† Ø§Ù„Ø£Ø­Ø¯Ø« Ù„Ù„Ø£Ù‚Ø¯Ù…
        allNotifications.sort((a, b) => b.time - a.time);
        
        list.innerHTML = ""; 
        allNotifications.slice(0, 10).forEach(n => {
            const item = document.createElement('div');
            item.className = "notif-item";
            item.style.cssText = "padding: 12px; border-bottom: 1px solid rgba(255,255,255,0.05); border-right: 3px solid " + n.color + "; margin-bottom: 5px; background: rgba(255,255,255,0.02);";
            
            item.innerHTML = `
                <div style="color: ${n.color}; font-weight: bold; font-size: 0.75rem; margin-bottom: 3px;">${n.icon} ${n.type}</div>
                <div style="font-size: 0.8rem; color: #e2e8f0; line-height: 1.4;">${n.title}</div>
                <div style="font-size: 0.65rem; color: #64748b; margin-top: 5px;"><i class="far fa-clock"></i> ${timeSince(n.time)}</div>
            `;
            list.appendChild(item);
        });
    };

    // 1. Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹ Ù„Ù„Ø¥Ø¹Ù„Ø§Ù†Ø§Øª
    db.collection("announcements").orderBy("createdAt", "desc").limit(5).onSnapshot(snap => {
        snap.docChanges().forEach(change => {
            if (change.type === "added") {
                const data = change.doc.data();
                if (data.createdAt) {
                    allNotifications.push({
                        type: "Ø¥Ø¹Ù„Ø§Ù† Ø¬Ø¯ÙŠØ¯",
                        title: data.message,
                        time: data.createdAt,
                        icon: "ğŸ“¢",
                        color: "var(--accent-gold)"
                    });
                    if (!snap.metadata.hasPendingWrites) { badge.style.display = 'block'; sound.play().catch(()=>{}); }
                }
            }
        });
        updateUI();
    });

    // 2. Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹ Ù„Ù„Ø¯Ø±ÙˆØ³
    db.collection("lessons").orderBy("createdAt", "desc").limit(5).onSnapshot(snap => {
        snap.docChanges().forEach(change => {
            if (change.type === "added") {
                const data = change.doc.data();
                if (data.createdAt) {
                    allNotifications.push({
                        type: "Ø¯Ø±Ø³ Ø¬Ø¯ÙŠØ¯",
                        title: data.title,
                        time: data.createdAt,
                        icon: "ğŸ“š",
                        color: "#38bdf8" // Ø£Ø²Ø±Ù‚ Ø³Ù…Ø§ÙˆÙŠ Ù„Ù„Ø¯Ø±ÙˆØ³
                    });
                    if (!snap.metadata.hasPendingWrites) { badge.style.display = 'block'; }
                }
            }
        });
        updateUI();
    });

    // 3. Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹ Ù„Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª
    db.collection("quizzes").orderBy("createdAt", "desc").limit(5).onSnapshot(snap => {
        snap.docChanges().forEach(change => {
            if (change.type === "added") {
                const data = change.doc.data();
                if (data.createdAt) {
                    allNotifications.push({
                        type: "Ø§Ø®ØªØ¨Ø§Ø± Ø¬Ø¯ÙŠØ¯",
                        title: `Ø£Ø¶ÙŠÙ Ø³Ø¤Ø§Ù„ Ø¬Ø¯ÙŠØ¯ ÙÙŠ: ${data.chapter}`,
                        time: data.createdAt,
                        icon: "ğŸ¯",
                        color: "#f472b6" // ÙˆØ±Ø¯ÙŠ Ù„Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª
                    });
                    if (!snap.metadata.hasPendingWrites) { badge.style.display = 'block'; }
                }
            }
        });
        updateUI();
    });
}

// 2. ÙˆØ¸ÙŠÙØ© Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ø¹Ù„ÙˆÙŠ Ø§Ù„Ø°Ù‡Ø¨ÙŠ
function showTopBar(msg) {
    const topBar = document.getElementById('globalAnnouncement');
    const msgSpan = document.getElementById('announcementMsg');
    if(topBar && msgSpan) {
        msgSpan.innerText = msg;
        topBar.style.display = 'block';
    }
}

// 3. ÙˆØ¸ÙŠÙØ© Ø±Ø³Ù… Ø§Ù„Ø¥Ø´Ø¹Ø§Ø± ÙÙŠ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© (Ù†Ø³Ø®Ø© ÙˆØ§Ø­Ø¯Ø© Ù†Ù‡Ø§Ø¦ÙŠØ©)
function renderNotifUI(container, badge, sound, info, shouldAlert) {
    // Ø­Ø°Ù Ø±Ø³Ø§Ù„Ø© "Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¥Ø´Ø¹Ø§Ø±Ø§Øª"
    if (container.innerHTML.includes("Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¥Ø´Ø¹Ø§Ø±Ø§Øª")) container.innerHTML = "";

    const item = document.createElement('div');
    item.className = "notif-item";
    item.style.cssText = "padding: 12px; border-bottom: 1px solid rgba(255,255,255,0.05); animation: fadeIn 0.5s ease;";
    
    const timeStr = info.time ? timeSince(info.time) : "Ø§Ù„Ø¢Ù†";
    
    item.innerHTML = `
        <div style="color: var(--accent-gold); font-weight: bold; font-size: 0.75rem; margin-bottom: 3px;">${info.type}</div>
        <div style="font-size: 0.8rem; color: #e2e8f0; line-height: 1.4;">${info.title}</div>
        <div style="font-size: 0.65rem; color: #64748b; margin-top: 5px;"><i class="far fa-clock"></i> ${timeStr}</div>
    `;

    container.prepend(item);

    // ØªÙØ¹ÙŠÙ„ Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡ (Ø§Ù„Ù†Ù‚Ø·Ø© Ø§Ù„Ø­Ù…Ø±Ø§Ø¡ ÙˆØ§Ù„ØµÙˆØª) ÙÙ‚Ø· Ù„Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
    if (shouldAlert) {
        badge.style.display = 'block';
        if (sound) {
            sound.play().catch(() => console.log("Ø§Ù„ØµÙˆØª Ø³ÙŠØ¹Ù…Ù„ Ø¨Ø¹Ø¯ ØªÙØ§Ø¹Ù„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ğŸŒ¸"));
        }
    }
}

// ÙˆØ¸ÙŠÙØ© Ù…Ø³Ø§Ø¹Ø¯Ø© Ù„Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ø¹Ù„ÙˆÙŠ
function showTopBar(msg) {
    const topBar = document.getElementById('globalAnnouncement');
    const msgSpan = document.getElementById('announcementMsg');
    if(topBar && msgSpan) {
        msgSpan.innerText = msg;
        topBar.style.display = 'block';
    }
}


    async function submitComment() {
        const text = document.getElementById('commentInput').value;
        if (!text || currentRating === 0) { alert("Ù„Ø·ÙØ§Ù‹ Ø¶Ø¹ÙŠ ØªÙ‚ÙŠÙŠÙ…Ø§Ù‹ ÙˆØªØ¹Ù„ÙŠÙ‚Ø§Ù‹ ğŸŒ¸"); return; }
        await db.collection("comments").add({
            studentName: document.getElementById('headerUserName').innerText,
            comment: text,
            rating: currentRating,
            lesson: currentLessonTitle,
            status: "pending",
            createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        alert("ØªÙ… Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ØŒ Ø³ÙŠØ¸Ù‡Ø± Ø¨Ø¹Ø¯ Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© âœ¨");
        document.getElementById('commentInput').value = "";
        setRating(0);
    }

    // --- Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± (Quiz) ØªÙ… Ø¥ØµÙ„Ø§Ø­ Ø§Ù„Ø®Ø·Ø£ Ù‡Ù†Ø§ ---
    async function startQuiz(cat) {
        const snap = await db.collection("quizzes").where("category", "==", cat).get();
        if (snap.empty) { alert("Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ø³Ø¦Ù„Ø© Ø­Ø§Ù„ÙŠØ§Ù‹"); return; }
        document.getElementById('quizStage1').style.display = 'none';
        document.getElementById('quizStage2').style.display = 'block';
        const q = snap.docs[0].data();
        document.getElementById('quizQuestion').innerText = q.question;
        const optBox = document.getElementById('quizOptions'); 
        optBox.innerHTML = "";
        
        // Ø¨Ù†Ø§Ø¡ Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ù„ÙƒÙ„ Ø®ÙŠØ§Ø±
        if(q.options) {
            q.options.forEach((option, i) => {
                const btn = document.createElement('div');
                btn.className = "nav-link";
                btn.style.border = "1px solid rgba(255,255,255,0.1)";
                btn.style.margin = "5px 0";
                btn.innerText = option;
                btn.onclick = () => {
                    const name = document.getElementById('headerUserName').innerText;
                    alert(i == q.correct ? `Ø±Ø§Ø¦Ø¹Ø© ÙŠØ§ ${name}! ğŸ‰` : "Ø­Ø§ÙˆÙ„ÙŠ Ù…Ø¬Ø¯Ø¯Ø§Ù‹ ğŸŒ¸"); 
                    closeQuiz();
                };
                optBox.appendChild(btn);
            });
        }
    }

    const logoutAction = () => auth.signOut().then(() => window.location.href = "login.html");
    document.getElementById('logoutBtnModal').onclick = logoutAction;
</script>
</body>
</html>